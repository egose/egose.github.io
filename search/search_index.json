{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Express Toolkit","text":"<p>Express Toolkit is a collection of Node.js libraries built on Express.</p>"},{"location":"#mongoose-acl","title":"Mongoose ACL","text":"<ul> <li>see details on Mongoose ACL</li> </ul>"},{"location":"api-request-handler/","title":"API Request Handler","text":""},{"location":"mongoose-acl/1.philosophy/","title":"Philosophy","text":"<p><code>@egose/acl</code> exposes REST API endpoints corresponding to mongoose data models in Express routes. It builds the backend database security layer by decorating mongoose queries, which enables dynamic frontend mongoose-like query options.</p> <p> </p>"},{"location":"mongoose-acl/1.philosophy/#motivation","title":"Motivation","text":"<p>REST (Representational State Transfer) is an API protocol which was introduced in a 2000, and is one of major API standards today. Besides its many benefits, there are also disadvantages to RESTful APIs. One of the disadvantages is that there is no good solution to manage object data at a fine-grained level unless opening up more API endpoints.</p> <p>Let's say we have a <code>User</code> model contains following fields:</p> <pre><code>- name\n- address\n- roles\n- creditBalance\n- loginDate\n</code></pre> <ul> <li><code>GET /users/{id}</code> to retrieve an user entity identified by user ID</li> </ul> <p>By making a request to this endpoint, it will return the user's data including the 6 fields above. What if we want to allow selected fields depending on the requester's roles on the system? <code>admin</code> and <code>member</code>. Probably, we will include conditional logic at the backend to exclude fields that <code>non-admin</code> is not allowed to read. But, does it actually solve the cases we will have when building a web application? Even though <code>admin</code> is permitted to read all fields of the entity, some fields could be redundant for certain screens.</p> <p>To retrieve selected fields only, we might send more information to the API call, such as <code>GET /users/{id}?include=partial[|all]</code>. However, this approach will make the backend codebase messy soon as more screens require diffrent entity fields and more backend conditional logic to handle all possible cases.</p> <ul> <li><code>PUT /users/{id}</code> to update an user entity identified by user ID</li> </ul> <p>Typically, <code>UPDATE</code> endpoint contains more complicated logic to prevent unwanted updates by wrong user types. For example, there might be a case that <code>admin</code> can update the first 5 fields while the user itself can update the first 3 fields only. If handling each scenario at the backend codebase, it will be inevitable to have multiple conditional logic depends on the complexity of the user types and the entity relationships.</p>"},{"location":"mongoose-acl/1.philosophy/#concept","title":"Concept","text":"<p>The idea is to build a security boundary defined in a schema for each resource to be consumed at the backend routes; because this security layer works as a wrapper around the request information sent by the browser, it gives the frontend codebase the most flexibility to build queries and manage data within the given API endpoints by the library.</p> <p>Object permissions are checked if global permissions pass and define whether a user has the ability to perform a specific action on a single object. These are also known as row level permissions.</p> <ul> <li>Global Permissions</li> </ul> <p>Global permissions are system-wide and granted to authenticated users based on their roles and allow <code>role-based access control (RBAC)</code> to the backend system. Global permissions are expected in <code>Express request object</code> (e.g. <code>req._permissions</code>) and used to apply access control to the system and resources.</p> <ul> <li>Document Permissions</li> </ul> <p>Document permissions are object-level privileges and defined to allow performing specific actions on a single <code>Mongoose document</code>.</p> <ul> <li> <p>Role-based Security</p> </li> <li> <p>Document-level Security</p> </li> <li> <p>Field-level security</p> </li> <li> <p>Base Query</p> </li> </ul> <p>Base queries are generated to decoreate <code>Mongoose Query object</code> to apply global permissions to a target collection.</p> <ul> <li>Mongoose Query Syntax</li> </ul> <p>Library API endpoints take a similar request structure as <code>Mongoose Syntax</code>, e.g. query, select, and populate, to reduce the learning curve of a new tool.</p>"},{"location":"mongoose-acl/2.quick-start/","title":"Quick Start","text":"<p>Please have <code>express</code> and <code>mongoose</code> installed in advance.</p>"},{"location":"mongoose-acl/2.quick-start/#installation","title":"Installation","text":"<pre><code>$ npm install express-mongoose-acl\n</code></pre> <pre><code>$ yarn add express-mongoose-acl\n</code></pre>"},{"location":"mongoose-acl/2.quick-start/#quick-start_1","title":"Quick Start","text":""},{"location":"mongoose-acl/2.quick-start/#global-permissions","title":"Global Permissions","text":"<p><code>Global Permissions</code> are fundamental elements of <code>role-based access control (RBAC)</code> to the backend API endpoints.</p> <pre><code>// create Mongoose models beforehand\nimport macl from 'express-mongoose-acl';\n\nmacl.set('globalPermissions', function (req) {\n  const user = req.user;\n\n  if (!user) return { isGuest: true };\n\n  return {\n    isGuest: false,\n    isAdmin: user.roles.includes('admin'),\n    isManager: user.roles.includes('manager'),\n  };\n});\n</code></pre> <p>It will set the global permission object to Express request object; <code>request._permissions</code>. To change the <code>permission field name</code>, update the global option <code>permissionField</code>:</p> <pre><code>macl.set('permissionField', 'mypermissions');\n</code></pre>"},{"location":"mongoose-acl/2.quick-start/#model-router","title":"Model Router","text":"<p>To create pre-defined Express routes binding to a Mongoose model, simply create a model router:</p> <pre><code>const userRouter = macl.createRouter('User', { baseUrl: 'users' });\n</code></pre> <p>The first argument must match a Mongoose model name created beforehand.</p>"},{"location":"mongoose-acl/2.quick-start/#route-guard","title":"Route Guard","text":"<p>Route Guard applies <code>role-based security</code> and restricts access to the backend API endpoints based on the global permissions. The available routes are <code>Create</code>, <code>Read</code>, <code>Update</code>, <code>Delete</code>, and <code>List</code> (CRUDL); it only allows API requests with valid checks and excludes the omitted routes. There is more than one way to validate the access:</p> <ul> <li><code>boolean</code>: true | false</li> <li><code>string</code>: valid if the key returns true in the global permissions</li> <li><code>array</code>: valid if any of the keys returns true in the global permissions</li> <li><code>function</code>: valid if the function returns true</li> </ul> <pre><code>userRouter.routeGuard({\n  list: true,\n  read: ['isAdmin', 'isManager'],\n  update: 'isAdmin',\n  create: function (globalPermissions) {\n    // `this` refers to Express request object\n    if (globalPermissions.isAdmin) return true;\n    return false;\n  },\n  delete: false,\n});\n</code></pre>"},{"location":"mongoose-acl/2.quick-start/#base-query","title":"Base Query","text":"<p>Base Query applies <code>document-level security</code> to control access to individual documents in a collection. It decorates Mongoose Query object to define the permission guardrails based on the global permissions.</p> <pre><code>userRouter.baseQuery({\n  list: function (permissions: Permissions) {\n    return true;\n  },\n  read: function (permissions: Permissions) {\n    if (permissions.isAdmin) return {};\n    else return { $or: [{ _id: this.user._id }, { roles: 'user' }] };\n  },\n  update: function (permissions: Permissions) {\n    if (permissions.isAdmin) return {};\n    else return { _id: this.user._id };\n  },\n  delete: function (permissions: Permissions) {\n    return permissions.isAdmin;\n  },\n});\n</code></pre> <p>For example, in the case of non-admin updating the user of ID <code>123456</code>, it will generate a query as below behind the scenes:</p> <pre><code>const query = { $and: [{ _id: this.user._id }, { _id: '123456' }] };\nconst result = await mongoose.model('User').findOne(query);\n</code></pre>"},{"location":"mongoose-acl/2.quick-start/#permission-schema","title":"Permission Schema","text":"<p><code>Permission schema</code> defines the fine-grained resource control mapping based on the global and optional document permissions. It applies <code>field-level security</code> to control access to individual fields within a document while <code>Base Query</code> works in <code>document-level security</code>. If no field-level security rule is defined for a field, the field is protected by all actions, <code>list</code>, <code>read</code>, <code>update</code> and <code>create</code>.</p> <pre><code>userRouter.permissionSchema({\n  name: { list: true, read: true, update: 'edit.name', create: true },\n  roles: {\n    list: ['isAdmin', 'isManager'],\n    read: 'isAdmin',\n    update: function (permissions: Permissions, docPermissions) {\n      // `this` refers to Express request object\n      if (docPermissions['edit.roles']) return true;\n      return false;\n    },\n    create: 'isAdmin',\n  },\n});\n</code></pre> <ul> <li>global permissions are available in all actions.</li> <li>document permissions are also available in <code>update</code> and <code>create</code> actions; for example, <code>edit.name</code> is a document permission generated by the router option <code>docPermissions</code>.</li> </ul>"},{"location":"mongoose-acl/2.quick-start/#document-permissions","title":"Document Permissions","text":"<p><code>Document permissions</code> play a key role for <code>field-level security</code> and available in applicable middleware hooks. You can also find the document permissions in the frontend application and apply business logic in UI based on the permissions generated for the user.</p> <pre><code>userRouter.docPermissions(function (docOrObject, permissions: Permissions) {\n  const isMe = String(docOrObject._id) === String(this.user._id);\n\n  return {\n    'edit.name': permissions.isAdmin || isMe,\n    'edit.roles': permissions.isAdmin,\n  };\n});\n</code></pre>"},{"location":"mongoose-acl/3.middleware/","title":"Middleware","text":""},{"location":"mongoose-acl/3.middleware/#validate","title":"Validate","text":"<p><code>Validate</code> hooks are called before a new/update document data is processed in <code>prepare</code> hooks. This method is used to validate <code>write data</code> and throw an error if not valid; available in <code>create</code> and <code>update</code> operations.</p> <pre><code>userRouter.validate({\n  create: function (docObject, permissions, context) {\n    // add create validate logic\n    const validated = validate(docObject);\n    return validated;\n  },\n  update: function (docObject, permissions, context) {\n    // add update validate logic\n    const validated = validate(docObject);\n    return validated;\n  },\n});\n</code></pre> <p>or define individual hooks.</p> <pre><code>userRouter.validate('create', function (docObject, permissions, context) {\n  // add create validate logic\n  const validated = validate(docObject);\n  return validated;\n});\n</code></pre>"},{"location":"mongoose-acl/3.middleware/#prepare","title":"Prepare","text":"<p><code>Prepare</code> hooks are called before a new document is created or an existing document is updated. This method is used to process raw data passed into the API endpoints; available in <code>create</code> and <code>update</code> operations.</p> <pre><code>userRouter.prepare({\n  create: function (docObject, permissions, context) {\n    // add create prepare logic\n    const processed = process(docObject);\n    return processed;\n  },\n  update: function (docObject, permissions, context) {\n    // add update prepare logic\n    const processed = process(docObject);\n    return processed;\n  },\n});\n</code></pre> <p>or define individual hooks.</p> <pre><code>userRouter.prepare('create', function (docObject, permissions, context) {\n  // add create prepare logic\n  const processed = process(docObject);\n  return processed;\n});\n</code></pre>"},{"location":"mongoose-acl/3.middleware/#transform","title":"Transform","text":"<p><code>Transform</code> hook is called before an updated document is saved. This method is only available in <code>update</code> operation.</p> <pre><code>userRouter.transform(function (doc, permissions, context) {\n  // add transform logic\n  const processed = process(doc);\n  return processed;\n});\n</code></pre>"},{"location":"mongoose-acl/3.middleware/#decorate","title":"Decorate","text":"<p><code>Decorate</code> hooks are called before response data is sent. This method is used to process raw data to apply custom logic before sending the result; available in <code>list</code>, <code>read</code>, <code>create</code>, <code>update</code> operations.</p> <pre><code>userRouter.decorate({\n  list: function (docObject, permissions, context) {\n    // add list decorate logic\n    const processed = process(docObject);\n    return processed;\n  },\n  read: function (docObject, permissions, context) {\n    // add read decorate logic\n    const processed = process(docObject);\n    return processed;\n  },\n  create: function (docObject, permissions, context) {\n    // add create decorate logic\n    const processed = process(docObject);\n    return processed;\n  },\n  update: function (docObject, permissions, context) {\n    // add update decorate logic\n    const processed = process(docObject);\n    return processed;\n  },\n});\n</code></pre> <p>or define individual hooks.</p> <pre><code>userRouter.decorate('list', function (docObject, permissions, context) {\n  // add list decorate logic\n  const processed = process(docObject);\n  return processed;\n});\n</code></pre>"},{"location":"mongoose-acl/3.middleware/#decorate-all","title":"Decorate All","text":"<p><code>Decorate All</code> hooks are called before response data is sent and after <code>decorate</code> middleware runs. This method is used to process and filter multiple document objects before sending the result; available in <code>list</code> operations only.</p> <pre><code>userRouter.decorateAll(function (docObjects, permissions) {\n  // add process logic\n  const processed = process(docObjects);\n  return processed;\n});\n</code></pre>"},{"location":"mongoose-acl/4.workflow-lifecycle/","title":"Workflow Lifecycle","text":""},{"location":"mongoose-acl/4.workflow-lifecycle/#list","title":"List","text":"<p><code>List</code> operation executes hook methods in the following sequence:</p> Hook Parameters Description <code>docPermissions</code> <ol><li>Mongoose document</li><li>global permissions</li></ol> called after Mongoose execute the query; it runs on each document. <code>decorate</code> <ol><li>plain document object</li><li>global permissions</li><li>context object: <code>docPermissions</code></li></ol> runs on each document object. <code>decorateAll</code> <ol><li>plain document objects</li><li>global permissions</li></ol> runs on set of document objects."},{"location":"mongoose-acl/4.workflow-lifecycle/#read","title":"Read","text":"<p><code>Read</code> operation executes hook methods in the following sequence:</p> Hook Parameters Description <code>docPermissions</code> <ol><li>Mongoose document</li><li>global permissions</li></ol> called after Mongoose execute the query. <code>decorate</code> <ol><li>plain document object</li><li>global permissions</li><li>context object: <code>docPermissions</code></li></ol>"},{"location":"mongoose-acl/4.workflow-lifecycle/#update","title":"Update","text":"<p><code>Update</code> operation executes hook methods in the following sequence:</p> Hook Parameters Description <code>docPermissions</code> <ol><li>Mongoose document</li><li>global permissions</li></ol> called after Mongoose execute the query. <code>validate</code> <ol><li>allowed object</li><li>global permissions</li><li>context object: <code>originalDoc</code>, <code>originalData</code>, <code>currentDoc</code></li></ol> <code>prepare</code> <ol><li>allowed object</li><li>global permissions</li><li>context object: <code>originalDoc</code>, <code>originalData</code>, <code>currentDoc</code></li></ol> <code>transform</code> <ol><li>allowed object</li><li>global permissions</li><li>context object: <code>originalDoc</code>, <code>originalData</code>, <code>currentDoc</code>, <code>preparedData</code>, <code>modifiedPaths</code></li></ol> called before changes saved. <code>docPermissions</code> <ol><li>Mongoose document</li><li>global permissions</li><li>context object: <code>originalDoc</code>, <code>originalData</code>, <code>currentDoc</code>, <code>preparedData</code>, <code>modifiedPaths</code></li></ol> called after changes saved. <code>decorate</code> <ol><li>plain document object</li><li>global permissions</li><li>context object: <code>originalDoc</code>, <code>originalData</code>, <code>currentDoc</code>, <code>preparedData</code>, <code>modifiedPaths</code>, <code>`docPermissions</code></li></ol>"},{"location":"mongoose-acl/4.workflow-lifecycle/#create","title":"Create","text":"<p><code>Create</code> operation executes hook methods in the following sequence:</p> Hook Parameters Description <code>validate</code> <ol><li>allowed object</li><li>global permissions</li><li>context object: <code>originalData</code></li><ol> <code>prepare</code> <ol><li>allowed object</li><li>global permissions</li><li>context object: <code>originalData</code></li></ol> <code>docPermissions</code> <ol><li>Mongoose document</li><li>global permissions</li><li>context object: <code>originalData</code>, <code>preparedData</code></li></ol> called after a document created. <code>decorate</code> <ol><li>plain document object</li><li>global permissions</li><li>context object: <code>originalData</code>, <code>preparedData</code></li></ol>"},{"location":"mongoose-acl/5.api-endpoints/","title":"API Endpoints","text":""},{"location":"mongoose-acl/5.api-endpoints/#list-resources-get","title":"List Resources GET","text":"<p>This entrypoint returns a set of resources.</p> <ul> <li><code>GET /{base_url}</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters","title":"Parameters","text":"Name Type In Description <code>limit</code> number query The maximum number of documents <code>page</code> number query The page number of documents; starts from 1 <code>include_permissions</code> boolean query Whether to include document permissions in each document <code>include_count</code> boolean query Whether to include total results count <code>lean</code> boolean query Whether to pass plain objects, not Mongoose Documents, in middleware"},{"location":"mongoose-acl/5.api-endpoints/#example","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request","title":"request","text":"<pre><code>curl \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users?limit=100&amp;page=5&amp;include_permissions=false&amp;include_count=false&amp;lean=true\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>[\n  {\n    \"name\": \"Andrew\",\n    \"address\": \"5d6ede6a0ba62570afcedd3a\",\n    \"roles\": [\"user\"],\n    \"creditBalance\": 100,\n    \"loginDate\": \"2022-02-22T02:02:22.679Z\"\n  }\n]\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#list-resources-post","title":"List Resources POST","text":"<p>This entrypoint returns a set of resources.</p> <ul> <li><code>POST /{base_url}/__query</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_1","title":"Parameters","text":"Name Type In Description <code>query</code> object body Mongoose Query object <code>select</code> object | array&lt;string&gt; body Document fields to include or exclude <code>populate</code> array&lt;string&gt; | array&lt;object&gt; body Document fields to populate <code>sort</code> object body Document sort order <code>limit</code> number body The maximum number of documents <code>page</code> number body The page number of documents; starts from 1 <code>options.includePermissions</code> boolean body Whether to include document permissions in each document <code>options.includeCount</code> boolean body Whether to include total results count <code>options.populateAccess</code> 'list' | 'read' body The access level to use in <code>populate</code> method <code>options.lean</code> boolean body Whether to pass plain objects, not Mongoose Documents, in middleware"},{"location":"mongoose-acl/5.api-endpoints/#example_1","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_1","title":"request","text":"<pre><code>curl \\\n  -X POST \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/__query \\\n  -d '{\n    \"query\": { \"loginDate\": { \"$gte\": \"2022-02-22T02:02:22.679Z\" } },\n    \"select\": [\"name\", \"address\"],\n    \"populate\": [\"address\"],\n    \"sort\": { \"createdAt\": -1 },\n    \"limit\": 100,\n    \"page\": 5,\n    \"options\": {\n      \"includePermissions\": true,\n      \"includeCount\": true,\n      \"populateAccess\": \"list\",\n      \"lean\": true\n    }\n  }'\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_1","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>{\n  \"count\": 2,\n  \"rows\": [\n    {\n      \"_id\": \"5d6ede6a0ba62570afcedd3a\",\n      \"name\": \"Mike\",\n      \"address\": {\n        \"city\": \"Seattle\",\n        \"country\": \"USA\"\n      },\n      \"_permissions\": {\n        \"edit\": true\n      }\n    },\n    {\n      \"_id\": \"5d6ede6a0ba62570afcedd3b\",\n      \"name\": \"Jennifer\",\n      \"address\": {\n        \"city\": \"Vancouver\",\n        \"country\": \"Canada\"\n      },\n      \"_permissions\": {\n        \"edit\": false\n      }\n    }\n  ]\n}\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#create-resource-post","title":"Create Resource POST","text":"<p>This entrypoint creates a resource.</p> <ul> <li><code>POST /{base_url}</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#example_2","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_2","title":"request","text":"<pre><code>curl \\\n  -X POST \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users \\\n  -d '{ \"name\": \"Jane\" }'\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_2","title":"response","text":"<pre><code>Status: 201\n</code></pre> <pre><code>{\n  \"_id\": \"5d6ede6a0ba62570afcedd3b\",\n  \"name\": \"Jane\",\n  \"address\": null,\n  \"roles\": [\"user\"],\n  \"creditBalance\": 0,\n  \"loginDate\": null\n}\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#new-resource-get","title":"New Resource GET","text":"<p>This entrypoint returns an empty resource and is used to retrieve sample data as a placeholder.</p> <ul> <li><code>GET /{base_url}/new</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#example_3","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_3","title":"request","text":"<pre><code>curl \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/new\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_3","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>{\n  \"_id\": \"5d6ede6a0ba62570afcedd3b\",\n  \"name\": null,\n  \"address\": null,\n  \"roles\": [\"user\"],\n  \"creditBalance\": 0,\n  \"loginDate\": null\n}\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#read-resource-get","title":"Read Resource GET","text":"<p>This entrypoint returns a target resource.</p> <ul> <li><code>GET /{base_url}/:id</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_2","title":"Parameters","text":"Name Type In Description <code>id</code> string param Resource identifier; defaults to Mongoose document ID <code>include_permissions</code> boolean query Whether to include document permissions in each document <code>try_list</code> boolean query Whether to attempt to retrieve the resource if not allowed <code>lean</code> boolean query Whether to pass plain objects, not Mongoose Documents, in middleware"},{"location":"mongoose-acl/5.api-endpoints/#example_4","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_4","title":"request","text":"<pre><code>curl \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/5d6ede6a0ba62570afcedd3b?try_list=true&amp;include_permissions=false&amp;lean=true\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_4","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>{\n  \"_id\": \"5d6ede6a0ba62570afcedd3b\",\n  \"name\": \"Andrew\",\n  \"address\": \"5d6ede6a0ba62570afcedd3a\",\n  \"roles\": [\"user\"],\n  \"creditBalance\": 100,\n  \"loginDate\": \"2022-02-22T02:02:22.679Z\"\n}\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#read-resource-post","title":"Read Resource POST","text":"<p>This entrypoint returns a target resource.</p> <ul> <li><code>POST /{base_url}/:id</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_3","title":"Parameters","text":"Name Type In Description <code>id</code> string param Resource identifier; defaults to Mongoose document ID <code>select</code> object | array&lt;string&gt; body Document fields to include or exclude <code>populate</code> array&lt;string&gt; | array&lt;object&gt; body Document fields to populate <code>options.includePermissions</code> boolean body Whether to include document permissions in each document <code>options.tryList</code> boolean body Whether to attempt to retrieve the resource if not allowed <code>options.populateAccess</code> 'list' | 'read' body The access level to use in <code>populate</code> method <code>options.lean</code> boolean body Whether to pass plain objects, not Mongoose Documents, in middleware"},{"location":"mongoose-acl/5.api-endpoints/#example_5","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_5","title":"request","text":"<pre><code>curl \\\n  -X POST \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/5d6ede6a0ba62570afcedd3b \\\n  -d '{\n    \"select\": [\"name\", \"address\"],\n    \"populate\": [\"address\"],\n    \"options\": {\n      \"includePermissions\": true,\n      \"tryList\": true,\n      \"populateAccess\": \"list\",\n      \"lean\": true\n    }\n  }'\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_5","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>{\n  \"_id\": \"5d6ede6a0ba62570afcedd3b\",\n  \"name\": \"Andrew\",\n  \"address\": {\n    \"city\": \"Seattle\",\n    \"country\": \"USA\"\n  }\n}\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#update-resource-put","title":"Update Resource PUT","text":"<p>This entrypoint updates a target resource.</p> <ul> <li><code>PUT /{base_url}/:id</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_4","title":"Parameters","text":"Name Type In Description <code>id</code> string param Resource identifier; defaults to Mongoose document ID <code>returning_all</code> boolean query Whether to return entire document or partial document"},{"location":"mongoose-acl/5.api-endpoints/#example_6","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_6","title":"request","text":"<pre><code>curl \\\n  -X PUT \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/5d6ede6a0ba62570afcedd3b?returning_all=false \\\n  -d '{ \"name\": \"Andrew-2nd\" }'\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_6","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>{\n  \"name\": \"Andrew-2nd\"\n}\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#delete-resource-delete","title":"Delete Resource DELETE","text":"<p>This entrypoint deletes a target resource.</p> <ul> <li><code>DELETE /{base_url}/:id</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_5","title":"Parameters","text":"Name Type In Description <code>id</code> string param Resource identifier; defaults to Mongoose document ID"},{"location":"mongoose-acl/5.api-endpoints/#example_7","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_7","title":"request","text":"<pre><code>curl \\\n  -X DELETE \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/5d6ede6a0ba62570afcedd3b\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_7","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>\"5d6ede6a0ba62570afcedd3b\"\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#distinct-field-values-get","title":"Distinct Field Values GET","text":"<p>This entrypoint finds the distinct values for a specified field across a target collection and returns the results in an array.</p> <ul> <li><code>GET /{base_url}/distinct/:field</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_6","title":"Parameters","text":"Name Type In Description <code>field</code> string param The field for which to return distinct values"},{"location":"mongoose-acl/5.api-endpoints/#example_8","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_8","title":"request","text":"<pre><code>curl \\\n  -X GET \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/name\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_8","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>[\"Andrew\", \"Andrew-2nd\", \"Mike\"]\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#distinct-field-values-post","title":"Distinct Field Values POST","text":"<p>This entrypoint finds the distinct values for a specified field across a target collection and returns the results in an array.</p> <ul> <li><code>POST /{base_url}/distinct/:field</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_7","title":"Parameters","text":"Name Type In Description <code>field</code> string param The field for which to return distinct values <code>query</code> string body Mongose query that specifies the match rules to retrieve the distinct values"},{"location":"mongoose-acl/5.api-endpoints/#example_9","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_9","title":"request","text":"<pre><code>curl \\\n  -X POST \\\n  -H \"Accept: application/json\" \\\n  https://example.com/users/name \\\n  -d '{\n    \"query\": {\n      \"name\": { \"$regex\": \"drew\", \"$options\": \"i\" }\n    }\n  }'\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_9","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>[\"Andrew\", \"Andrew-2nd\"]\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#count-documents-get","title":"Count Documents GET","text":"<p>This entrypoint returns the count of documents that would match a query for the collection.</p> <ul> <li><code>GET /{base_url}/count</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#example_10","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_10","title":"request","text":"<pre><code>curl \\\n  -X GET \\\n  -H \"Accept: application/json\" \\\n  https://example.com/count\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_10","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>3\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#count-documents-post","title":"Count Documents POST","text":"<p>This entrypoint returns the count of documents that would match a query for the collection.</p> <ul> <li><code>POST /{base_url}/distinct/:field</code></li> </ul>"},{"location":"mongoose-acl/5.api-endpoints/#parameters_8","title":"Parameters","text":"Name Type In Description <code>query</code> string body Mongose query that specifies the match rules to retrieve the distinct values <code>access</code> 'list' | 'read' body The access level to use in <code>find</code> method"},{"location":"mongoose-acl/5.api-endpoints/#example_11","title":"Example","text":""},{"location":"mongoose-acl/5.api-endpoints/#request_11","title":"request","text":"<pre><code>curl \\\n  -X POST \\\n  -H \"Accept: application/json\" \\\n  https://example.com/count \\\n  -d '{\n    \"query\": {\n      \"name\": { \"$regex\": \"drew\", \"$options\": \"i\" }\n    },\n    \"access\": \"list\"\n  }'\n</code></pre>"},{"location":"mongoose-acl/5.api-endpoints/#response_11","title":"response","text":"<pre><code>Status: 200\n</code></pre> <pre><code>2\n</code></pre>"},{"location":"mongoose-acl/6.options/","title":"Options","text":""},{"location":"mongoose-acl/6.options/#global-options","title":"Global Options","text":"<p>Global options can be passed on to the <code>express-mongoose-acl</code> object itself.</p> <ul> <li><code>globalPermissions</code>: see <code>Quick Start - Global Permissions</code></li> <li><code>permissionField</code>: the global permission field name, default to <code>_permissions</code></li> <li><code>idParam</code>: the name of <code>Route parameter</code> that is used to capture the document ID, default to <code>id</code></li> </ul>"},{"location":"mongoose-acl/6.options/#model-router-options","title":"Model Router Options","text":"<p>Router options can be passed on to the instance constructor or to the each setter methods.</p> <ul> <li><code>baseUrl</code></li> <li><code>listHardLimit</code></li> <li><code>permissionSchema</code>: see <code>Quick Start - Permission Schema</code></li> <li><code>permissionField</code></li> <li><code>mandatoryFields</code></li> <li><code>docPermissions</code>: see <code>Quick Start - Document Permissions</code></li> <li><code>routeGuard</code>: see <code>Quick Start - Route Guard</code></li> <li><code>baseQuery</code>: see <code>Quick Start - Base Query</code></li> <li><code>validate</code>: see <code>Middleware - Validate</code></li> <li><code>prepare</code>: see <code>Middleware - Prepare</code></li> <li><code>transform</code>: see <code>Middleware - Transform</code></li> <li><code>decorate</code>: see <code>Middleware - Decorate</code></li> <li><code>decorateAll</code>: see <code>Middleware - Decorate All</code></li> <li> <p><code>identifier</code>: this option defines how <code>id param</code> is used to find the target document, defaults to <code>_id</code> field; there is more than one way to define the relation:</p> <ul> <li><code>string</code>: Mongoose document field key</li> <li><code>function</code>: Function returns a Mongoose query to find the target document.</li> </ul> </li> </ul> <pre><code>userRouter.identifier(function (id) {\n  return { $or: [{ _id: id }, { code: id }] };\n});\n</code></pre>"},{"location":"mongoose-acl/7.usage/","title":"Usage","text":""},{"location":"mongoose-acl/7.usage/#example","title":"Example","text":"<pre><code>import mongoose from 'mongoose';\nimport express from 'express';\nimport macl from 'express-mongoose-acl';\nimport { Permissions } from 'express-mongoose-acl/permission';\nconst router = express.Router();\n\nmongoose.model(\n  'User',\n  new mongoose.Schema({\n    name: { type: String },\n    address: { type: String },\n    roles: { type: String },\n    creditBalance: { type: Number },\n    loginDate: { type: Date },\n  }),\n);\n\nmacl.set('globalPermissions', function (req) {\n  const user = req.user;\n\n  if (!user) return { isGuest: true };\n\n  return {\n    isGuest: false,\n    isAdmin: user.roles.includes('admin'),\n    isManager: user.roles.includes('manager'),\n  };\n});\n\nconst userRouter = macl.createRouter('User', { baseUrl: null });\n\nuserRouter.routeGuard({\n  list: true,\n  read: ['isAdmin', 'isManager'],\n  update: 'isAdmin',\n  create: function (permissions: Permissions) {\n    // `this` refers to Express request object\n    if (permissions.isAdmin) return true;\n    return false;\n  },\n  delete: false,\n});\n\nuserRouter.baseQuery({\n  list: function (permissions: Permissions) {\n    return true;\n  },\n  read: function (permissions: Permissions) {\n    if (permissions.isAdmin) return {};\n    else return { $or: [{ _id: this.user._id }, { role: ['user'] }] };\n  },\n  update: function (permissions: Permissions) {\n    if (permissions.isAdmin) return {};\n    else return { _id: this.user._id };\n  },\n  delete: function (permissions: Permissions) {\n    return permissions.isAdmin;\n  },\n});\n\nuserRouter.permissionSchema({\n  name: { list: true, read: true, update: 'edit.name', create: true },\n  roles: {\n    list: ['isAdmin', 'isManager'],\n    read: 'isAdmin',\n    update: function (permissions: Permissions, docPermissions) {\n      // `this` refers to Express request object\n      if (docPermissions['edit.roles']) return true;\n      return false;\n    },\n    create: 'isAdmin',\n  },\n});\n\nuserRouter.docPermissions(function (docOrObject, permissions: Permissions) {\n  const isMe = String(docOrObject._id) === String(this.user._id);\n\n  return {\n    'edit.name': permissions.isAdmin || isMe,\n    'edit.roles': permissions.isAdmin,\n  };\n});\n\nuserRouter.prepare({\n  create: function (docObject, permissions: Permissions, context) {\n    const { originalData } = context;\n    // add create prepare function\n    return docObject;\n  },\n  update: function (docObject, permissions: Permissions, context) {\n    const { originalDoc, originalData, currentDoc } = context;\n    // add update prepare function\n    return docObject;\n  },\n});\n\nuserRouter.transform(function (doc, permissions: Permissions, context) {\n  const { originalDoc, originalData, currentDoc, preparedData, modifiedPaths } = context;\n  // add transform function\n  return doc;\n});\n\nuserRouter.decorate({\n  list: function (docObject, permissions: Permissions, context) {\n    const { docPermissions } = context;\n    // add list decorator function\n    return docObject;\n  },\n  read: function (docObject, permissions: Permissions, context) {\n    const { docPermissions } = context;\n    // add read decorator function\n    return docObject;\n  },\n  create: function (docObject, permissions: Permissions, context) {\n    const { originalData, preparedData, docPermissions } = context;\n    // add create decorator function\n    return docObject;\n  },\n  update: function (docObject, permissions: Permissions, context) {\n    const { originalDoc, originalData, currentDoc, preparedData, modifiedPaths, docPermissions } = context;\n    // add update decorator function\n    return docObject;\n  },\n});\n\nuserRouter.decorateAll(function (docObjects, permissions: Permissions) {\n  // add decorator-all function\n  return docObjects;\n});\n\nuserRouter.identifier(function (id) {\n  return { name: id };\n});\n\nrouter.use('/api/users', userRouter.routes);\n</code></pre>"}]}